#!/usr/bin/env bash

# shellcheck source=/dev/null
source "./.github/workflows/scripts/e2e-verify.common.sh"

# Script Inputs.
GITHUB_REF=${GITHUB_REF:-}
GITHUB_REF_NAME=${GITHUB_REF_NAME:-}
GITHUB_REF_TYPE=${GITHUB_REF_TYPE:-}
RUNNER_DEBUG=${RUNNER_DEBUG:-}
if [[ -n "${RUNNER_DEBUG}" ]]; then
    set -x
fi

go env -w GOFLAGS=-mod=mod

# verify_provenance_content verifies provenance content generated by the generic generator.
verify_provenance_content() {
    # Script Inputs.
    local provenance binary
    provenance=${PROVENANCE:-}
    binary=${BINARY:-}

    local attestation has_assets is_goreleaser annotated_tags this_file
    this_file=$(e2e_this_file)
    attestation=$(jq -r '.payload' <"${provenance}" | base64 -d)
    has_assets=$(echo "${this_file}" | cut -d '.' -f5 | grep assets)
    is_goreleaser=$(echo "${this_file}" | cut -d '.' -f5 | grep goreleaser)
    annotated_tags=$(echo "${this_file}" | cut -d '.' -f5 | grep annotated || true)

    echo "  **** Provenance content verification *****"

    # Verify all common provenance fields.
    e2e_verify_common_all "${attestation}"

    e2e_verify_predicate_subject_name "${attestation}" "${binary}"
    e2e_verify_predicate_builder_id "${attestation}" "https://github.com/slsa-framework/slsa-github-generator/.github/workflows/generator_generic_slsa3.yml@refs/heads/main"
    e2e_verify_predicate_buildType "${attestation}" "https://github.com/slsa-framework/slsa-github-generator/generic@v1"

    # Ignore the annotated tags, because they are not part of a release.
    if [[ "${GITHUB_REF_TYPE}" == "tag" ]] && [[ -z "${annotated_tags}" ]]; then
        assets=$(e2e_get_release_assets_filenames "${GITHUB_REF_NAME}")
        if [[ -z "${has_assets}" ]]; then
            e2e_assert_eq "${assets}" "[\"null\",\"null\"]" "there should be no assets"
        else
            if [[ -n "${is_goreleaser}" ]]; then
                if ! assert_not_empty "${assets}" "there should be assets"; then
                    exit 1
                fi
            else
                multi_subjects=$(echo "${this_file}" | cut -d '.' -f5 | grep multi-subjects)
                if [[ -n "${multi_subjects}" ]]; then
                    e2e_assert_eq "${assets}" "[\"multiple.intoto.jsonl\",\"null\"]" "there should be assets"
                else
                    e2e_assert_eq "${assets}" "[\"hello.intoto.jsonl\",\"null\"]" "there should be assets"
                fi
            fi
        fi
    fi
}

this_file=$(e2e_this_file)
branch=$(e2e_this_branch)
echo "branch is ${branch}"
echo "GITHUB_REF_NAME: ${GITHUB_REF_NAME}"
echo "GITHUB_REF_TYPE: ${GITHUB_REF_TYPE}"
echo "GITHUB_REF: ${GITHUB_REF}"
echo "DEBUG: file is ${this_file}"

export SLSA_VERIFIER_TESTING="true"

# Verify provenance authenticity with min version at release v2.5.1
# Due to the breaking change below, we only need to verify starting at v2.51
# https://github.com/slsa-framework/slsa-github-generator/issues/3350
e2e_run_verifier_all_releases "v2.5.1"

# Verify the provenance content.
verify_provenance_content
